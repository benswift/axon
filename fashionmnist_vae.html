<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.29.1">
    <meta name="project" content="Axon v0.3.0">

    <title>A Variational Autoencoder for MNIST — Axon v0.3.0</title>
    <link rel="stylesheet" href="dist/html-elixir-V2ETBPMB.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-IV5W3OL2.js"></script>
    <script src="dist/sidebar_items-D6F7A6F8.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/html-XN2TSG4M.js"></script>


  </head>
  <body data-type="extras" class="page-livemd">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">

<button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <i class="ri-search-2-line" aria-hidden="true" title="Submit search"></i>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <i class="ri-close-line ri-lg" aria-hidden="true" title="Cancel search"></i>
    </button>
    <label class="search-label">
      <p class="sr-only">Search</p>
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">

      <a href="Axon.html">
        <img src="assets/logo.png" alt="Axon" class="sidebar-projectImage">
      </a>

    <div class="sidebar-projectDetails">
      <a href="Axon.html" class="sidebar-projectName" translate="no">
Axon
      </a>
      <strong class="sidebar-projectVersion" translate="no">
        v0.3.0
      </strong>
    </div>
    <ul class="sidebar-listNav">
      <li><a id="extras-list-link" href="#full-list">Pages</a></li>

        <li><a id="modules-list-link" href="#full-list">Modules</a></li>


    </ul>
  </div>

  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>
<button class="icon-action display-settings">
  <i class="ri-settings-3-line"></i>
  <span class="sr-only">Settings</span>
</button>


    <a href="https://github.com/elixir-nx/axon/blob/v0.3.0/notebooks/generative/fashionmnist_vae.livemd#L1" title="View Source" class="icon-action" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>


  <span>A Variational Autoencoder for MNIST</span>
</h1>

  <div class="livebook-badge-container">
    <a href="#" class="livebook-badge">
      <img src="https://livebook.dev/badge/v1/blue.svg" alt="Run in Livebook" width="150" />
    </a>
  </div>

<pre><code class="makeup elixir" translate="no"><span class="nc">Mix</span><span class="o">.</span><span class="n">install</span><span class="p" data-group-id="7557513801-1">(</span><span class="p" data-group-id="7557513801-2">[</span><span class="w">
  </span><span class="p" data-group-id="7557513801-3">{</span><span class="ss">:exla</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.4.0&quot;</span><span class="p" data-group-id="7557513801-3">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="7557513801-4">{</span><span class="ss">:nx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.4.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">override</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="7557513801-4">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="7557513801-5">{</span><span class="ss">:axon</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.3.0&quot;</span><span class="p" data-group-id="7557513801-5">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="7557513801-6">{</span><span class="ss">:req</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.3.1&quot;</span><span class="p" data-group-id="7557513801-6">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="7557513801-7">{</span><span class="ss">:kino</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.7.0&quot;</span><span class="p" data-group-id="7557513801-7">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="7557513801-8">{</span><span class="ss">:scidata</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.1.9&quot;</span><span class="p" data-group-id="7557513801-8">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="7557513801-9">{</span><span class="ss">:stb_image</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.5.2&quot;</span><span class="p" data-group-id="7557513801-9">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="7557513801-10">{</span><span class="ss">:kino_vega_lite</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.1.6&quot;</span><span class="p" data-group-id="7557513801-10">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="7557513801-11">{</span><span class="ss">:vega_lite</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.1.6&quot;</span><span class="p" data-group-id="7557513801-11">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="7557513801-12">{</span><span class="ss">:table_rex</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 3.1.1&quot;</span><span class="p" data-group-id="7557513801-12">}</span><span class="w">
</span><span class="p" data-group-id="7557513801-2">]</span><span class="p" data-group-id="7557513801-1">)</span><span class="w">

</span><span class="kn">alias</span><span class="w"> </span><span class="nc">VegaLite</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="nc">Vl</span><span class="w">

</span><span class="c1"># This speeds up all our `Nx` operations without having to use `defn`</span><span class="w">
</span><span class="nc">Nx</span><span class="o">.</span><span class="n">global_default_backend</span><span class="p" data-group-id="7557513801-13">(</span><span class="nc">EXLA.Backend</span><span class="p" data-group-id="7557513801-13">)</span><span class="w">

</span><span class="ss">:ok</span></code></pre><h2 id="introduction" class="section-heading">
  <a href="#introduction" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">introduction</p>
  </a>
  Introduction
</h2>
<p>In this notebook, we'll be building a variational autoencoder (VAE). This will help demonstrate splitting up models, defining custom layers and loss functions, using multiple outputs, and a few additional Kino tricks for training models.</p><p>This notebook builds on the <a href="mnist_autoencoder_using_kino.html">denoising autoencoder example</a> and turns the simple autoencoder into a variational one for the same dataset.</p><h2 id="training-a-simple-autoencoder" class="section-heading">
  <a href="#training-a-simple-autoencoder" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">training-a-simple-autoencoder</p>
  </a>
  Training a simple autoencoder
</h2>
<p>This section will proceed without much explanation as most of it is extracted from <a href="mnist_autoencoder_using_kino.html">denoising autoencoder example</a>. If anything here doesn't make sense, take a look at that notebook for an explanation.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Data</span><span class="w"> </span><span class="k" data-group-id="8303325892-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  A module to hold useful data processing utilities,
  mostly extracted from the previous notebook
  &quot;&quot;&quot;</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Converts the given image into a `Kino.Image`.

  `image` must be a single channel `Nx` tensor with pixel values between 0 and 1.
  `height` and `width` are the output size in pixels
  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">image_to_kino</span><span class="p" data-group-id="8303325892-2">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="mi">200</span><span class="p" data-group-id="8303325892-2">)</span><span class="w"> </span><span class="k" data-group-id="8303325892-3">do</span><span class="w">
    </span><span class="n">image</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">multiply</span><span class="p" data-group-id="8303325892-4">(</span><span class="mi">255</span><span class="p" data-group-id="8303325892-4">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">as_type</span><span class="p" data-group-id="8303325892-5">(</span><span class="ss">:u8</span><span class="p" data-group-id="8303325892-5">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">transpose</span><span class="p" data-group-id="8303325892-6">(</span><span class="ss">axes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8303325892-7">[</span><span class="ss">:height</span><span class="p">,</span><span class="w"> </span><span class="ss">:width</span><span class="p">,</span><span class="w"> </span><span class="ss">:channels</span><span class="p" data-group-id="8303325892-7">]</span><span class="p" data-group-id="8303325892-6">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">StbImage</span><span class="o">.</span><span class="n">from_nx</span><span class="p" data-group-id="8303325892-8">(</span><span class="p" data-group-id="8303325892-8">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">StbImage</span><span class="o">.</span><span class="n">resize</span><span class="p" data-group-id="8303325892-9">(</span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p" data-group-id="8303325892-9">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">StbImage</span><span class="o">.</span><span class="n">to_binary</span><span class="p" data-group-id="8303325892-10">(</span><span class="ss">:png</span><span class="p" data-group-id="8303325892-10">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino.Image</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="8303325892-11">(</span><span class="ss">:png</span><span class="p" data-group-id="8303325892-11">)</span><span class="w">
  </span><span class="k" data-group-id="8303325892-3">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Converts image data from `Scidata.MNIST` into an `Nx` tensor and normalizes it.
  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">preprocess_data</span><span class="p" data-group-id="8303325892-12">(</span><span class="n">data</span><span class="p" data-group-id="8303325892-12">)</span><span class="w"> </span><span class="k" data-group-id="8303325892-13">do</span><span class="w">
    </span><span class="p" data-group-id="8303325892-14">{</span><span class="n">image_data</span><span class="p">,</span><span class="w"> </span><span class="c">_labels</span><span class="p" data-group-id="8303325892-14">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="w">
    </span><span class="p" data-group-id="8303325892-15">{</span><span class="n">images_binary</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="p" data-group-id="8303325892-15">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image_data</span><span class="w">

    </span><span class="n">images_binary</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">from_binary</span><span class="p" data-group-id="8303325892-16">(</span><span class="n">type</span><span class="p" data-group-id="8303325892-16">)</span><span class="w">
    </span><span class="c1"># Since pixels are organized row-wise, reshape into rows x columns</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="8303325892-17">(</span><span class="n">shape</span><span class="p">,</span><span class="w"> </span><span class="ss">names</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8303325892-18">[</span><span class="ss">:images</span><span class="p">,</span><span class="w"> </span><span class="ss">:channels</span><span class="p">,</span><span class="w"> </span><span class="ss">:height</span><span class="p">,</span><span class="w"> </span><span class="ss">:width</span><span class="p" data-group-id="8303325892-18">]</span><span class="p" data-group-id="8303325892-17">)</span><span class="w">
    </span><span class="c1"># Normalize the pixel values to be between 0 and 1</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">divide</span><span class="p" data-group-id="8303325892-19">(</span><span class="mi">255</span><span class="p" data-group-id="8303325892-19">)</span><span class="w">
  </span><span class="k" data-group-id="8303325892-13">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Converts a tensor of images into random batches of paired images for model training
  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">prepare_training_data</span><span class="p" data-group-id="8303325892-20">(</span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p" data-group-id="8303325892-20">)</span><span class="w"> </span><span class="k" data-group-id="8303325892-21">do</span><span class="w">
    </span><span class="nc">Stream</span><span class="o">.</span><span class="n">flat_map</span><span class="p" data-group-id="8303325892-22">(</span><span class="p" data-group-id="8303325892-23">[</span><span class="no">nil</span><span class="p" data-group-id="8303325892-23">]</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="8303325892-24">fn</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">images</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">shuffle</span><span class="p" data-group-id="8303325892-25">(</span><span class="ss">axis</span><span class="p">:</span><span class="w"> </span><span class="ss">:images</span><span class="p" data-group-id="8303325892-25">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched</span><span class="p" data-group-id="8303325892-26">(</span><span class="n">batch_size</span><span class="p" data-group-id="8303325892-26">)</span><span class="w">
    </span><span class="k" data-group-id="8303325892-24">end</span><span class="p" data-group-id="8303325892-22">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="8303325892-27">(</span><span class="k" data-group-id="8303325892-28">fn</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="8303325892-29">{</span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="p" data-group-id="8303325892-29">}</span><span class="w"> </span><span class="k" data-group-id="8303325892-28">end</span><span class="p" data-group-id="8303325892-27">)</span><span class="w">
  </span><span class="k" data-group-id="8303325892-21">end</span><span class="w">
</span><span class="k" data-group-id="8303325892-1">end</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="n">train_images</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Data</span><span class="o">.</span><span class="n">preprocess_data</span><span class="p" data-group-id="0496736831-1">(</span><span class="nc">Scidata.FashionMNIST</span><span class="o">.</span><span class="n">download</span><span class="p" data-group-id="0496736831-2">(</span><span class="p" data-group-id="0496736831-2">)</span><span class="p" data-group-id="0496736831-1">)</span><span class="w">
</span><span class="n">test_images</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Data</span><span class="o">.</span><span class="n">preprocess_data</span><span class="p" data-group-id="0496736831-3">(</span><span class="nc">Scidata.FashionMNIST</span><span class="o">.</span><span class="n">download_test</span><span class="p" data-group-id="0496736831-4">(</span><span class="p" data-group-id="0496736831-4">)</span><span class="p" data-group-id="0496736831-3">)</span><span class="w">

</span><span class="nc">Kino</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="0496736831-5">(</span><span class="n">train_images</span><span class="p" data-group-id="0496736831-6">[</span><span class="p" data-group-id="0496736831-7">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="0496736831-7">]</span><span class="p" data-group-id="0496736831-6">]</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Data</span><span class="o">.</span><span class="n">image_to_kino</span><span class="p" data-group-id="0496736831-8">(</span><span class="p" data-group-id="0496736831-8">)</span><span class="p" data-group-id="0496736831-5">)</span><span class="w">
</span><span class="nc">Kino</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="0496736831-9">(</span><span class="n">test_images</span><span class="p" data-group-id="0496736831-10">[</span><span class="p" data-group-id="0496736831-11">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="0496736831-11">]</span><span class="p" data-group-id="0496736831-10">]</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Data</span><span class="o">.</span><span class="n">image_to_kino</span><span class="p" data-group-id="0496736831-12">(</span><span class="p" data-group-id="0496736831-12">)</span><span class="p" data-group-id="0496736831-9">)</span><span class="w">

</span><span class="ss">:ok</span></code></pre><p>Now for our simple autoencoder model. We won't be using a denoising autoencoder here.</p><p>Note that we're giving each of the layers a name - the reason for this will be apparent later.</p><p>I'm also using a small custom layer to shift and scale the output of the sigmoid layer slightly so it can hit the 0 and 1 targets. I noticed the gradients tend to explode without this.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">CustomLayer</span><span class="w"> </span><span class="k" data-group-id="1526760049-1">do</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Nx.Defn</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">scaling_layer</span><span class="p" data-group-id="1526760049-2">(</span><span class="p" data-group-id="1526760049-3">%</span><span class="nc" data-group-id="1526760049-3">Axon</span><span class="p" data-group-id="1526760049-3">{</span><span class="p" data-group-id="1526760049-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="c">_opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="1526760049-4">[</span><span class="p" data-group-id="1526760049-4">]</span><span class="p" data-group-id="1526760049-2">)</span><span class="w"> </span><span class="k" data-group-id="1526760049-5">do</span><span class="w">
    </span><span class="nc">Axon</span><span class="o">.</span><span class="n">layer</span><span class="p" data-group-id="1526760049-6">(</span><span class="o">&amp;</span><span class="n">scaling_layer_impl</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1526760049-7">[</span><span class="n">input</span><span class="p" data-group-id="1526760049-7">]</span><span class="p" data-group-id="1526760049-6">)</span><span class="w">
  </span><span class="k" data-group-id="1526760049-5">end</span><span class="w">

  </span><span class="kd">defnp</span><span class="w"> </span><span class="nf">scaling_layer_impl</span><span class="p" data-group-id="1526760049-8">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="c">_opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="1526760049-9">[</span><span class="p" data-group-id="1526760049-9">]</span><span class="p" data-group-id="1526760049-8">)</span><span class="w"> </span><span class="k" data-group-id="1526760049-10">do</span><span class="w">
    </span><span class="n">x</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">subtract</span><span class="p" data-group-id="1526760049-11">(</span><span class="mf">0.05</span><span class="p" data-group-id="1526760049-11">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">multiply</span><span class="p" data-group-id="1526760049-12">(</span><span class="mf">1.2</span><span class="p" data-group-id="1526760049-12">)</span><span class="w">
  </span><span class="k" data-group-id="1526760049-10">end</span><span class="w">
</span><span class="k" data-group-id="1526760049-1">end</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Axon</span><span class="o">.</span><span class="n">input</span><span class="p" data-group-id="5379787308-1">(</span><span class="s">&quot;image&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">shape</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5379787308-2">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="5379787308-2">}</span><span class="p" data-group-id="5379787308-1">)</span><span class="w">
  </span><span class="c1"># This is now 28*28*1 = 784</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">flatten</span><span class="p" data-group-id="5379787308-3">(</span><span class="p" data-group-id="5379787308-3">)</span><span class="w">
  </span><span class="c1"># The encoder</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="5379787308-4">(</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;encoder_layer_1&quot;</span><span class="p" data-group-id="5379787308-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="5379787308-5">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;encoder_layer_2&quot;</span><span class="p" data-group-id="5379787308-5">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="5379787308-6">(</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;encoder_layer_3&quot;</span><span class="p" data-group-id="5379787308-6">)</span><span class="w">
  </span><span class="c1"># Bottleneck layer</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="5379787308-7">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bottleneck_layer&quot;</span><span class="p" data-group-id="5379787308-7">)</span><span class="w">
  </span><span class="c1"># The decoder</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="5379787308-8">(</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;decoder_layer_1&quot;</span><span class="p" data-group-id="5379787308-8">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="5379787308-9">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;decoder_layer_2&quot;</span><span class="p" data-group-id="5379787308-9">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="5379787308-10">(</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;decoder_layer_3&quot;</span><span class="p" data-group-id="5379787308-10">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="5379787308-11">(</span><span class="mi">784</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:sigmoid</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;decoder_layer_4&quot;</span><span class="p" data-group-id="5379787308-11">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">CustomLayer</span><span class="o">.</span><span class="n">scaling_layer</span><span class="p" data-group-id="5379787308-12">(</span><span class="p" data-group-id="5379787308-12">)</span><span class="w">
  </span><span class="c1"># Turn it back into a 28x28 single channel image</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="5379787308-13">(</span><span class="p" data-group-id="5379787308-14">{</span><span class="ss">:auto</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="5379787308-14">}</span><span class="p" data-group-id="5379787308-13">)</span><span class="w">

</span><span class="c1"># We can use Axon.Display to show us what each of the layers would look like</span><span class="w">
</span><span class="c1"># assuming we send in a batch of 4 images</span><span class="w">
</span><span class="nc">Axon.Display</span><span class="o">.</span><span class="n">as_table</span><span class="p" data-group-id="5379787308-15">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">template</span><span class="p" data-group-id="5379787308-16">(</span><span class="p" data-group-id="5379787308-17">{</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="5379787308-17">}</span><span class="p">,</span><span class="w"> </span><span class="ss">:f32</span><span class="p" data-group-id="5379787308-16">)</span><span class="p" data-group-id="5379787308-15">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="5379787308-18">(</span><span class="p" data-group-id="5379787308-18">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="n">batch_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="w">

</span><span class="n">train_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Data</span><span class="o">.</span><span class="n">prepare_training_data</span><span class="p" data-group-id="9726902351-1">(</span><span class="n">train_images</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p" data-group-id="9726902351-1">)</span><span class="w">
</span><span class="n">test_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Data</span><span class="o">.</span><span class="n">prepare_training_data</span><span class="p" data-group-id="9726902351-2">(</span><span class="n">test_images</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p" data-group-id="9726902351-2">)</span><span class="w">

</span><span class="p" data-group-id="9726902351-3">{</span><span class="n">input_batch</span><span class="p">,</span><span class="w"> </span><span class="n">target_batch</span><span class="p" data-group-id="9726902351-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p" data-group-id="9726902351-4">(</span><span class="n">train_data</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="9726902351-4">)</span><span class="w">
</span><span class="nc">Kino</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="9726902351-5">(</span><span class="n">input_batch</span><span class="p" data-group-id="9726902351-6">[</span><span class="p" data-group-id="9726902351-7">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="9726902351-7">]</span><span class="p" data-group-id="9726902351-6">]</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Data</span><span class="o">.</span><span class="n">image_to_kino</span><span class="p" data-group-id="9726902351-8">(</span><span class="p" data-group-id="9726902351-8">)</span><span class="p" data-group-id="9726902351-5">)</span><span class="w">
</span><span class="nc">Kino</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="9726902351-9">(</span><span class="n">target_batch</span><span class="p" data-group-id="9726902351-10">[</span><span class="p" data-group-id="9726902351-11">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="9726902351-11">]</span><span class="p" data-group-id="9726902351-10">]</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Data</span><span class="o">.</span><span class="n">image_to_kino</span><span class="p" data-group-id="9726902351-12">(</span><span class="p" data-group-id="9726902351-12">)</span><span class="p" data-group-id="9726902351-9">)</span><span class="w">

</span><span class="ss">:ok</span></code></pre><p>When training, it can be useful to stop execution early - either when you see it's failing and you don't want to waste time waiting for the remaining epochs to finish, or if it's good enough and you want to start experimenting with it.</p><p>The <code class="inline">kino_early_stop/1</code> function below is a handy handler to give us a <code class="inline">Kino.Control.button</code> that will stop the training loop when clicked.</p><p>We also have <code class="inline">plot_losses/1</code> function to visualize our train and validation losses using <a href="https://hexdocs.pm/vega_lite/0.1.6/VegaLite.html"><code class="inline">VegaLite</code></a>.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">KinoAxon</span><span class="w"> </span><span class="k" data-group-id="6921893243-1">do</span><span class="w">
  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Adds handler function which adds a frame with a &quot;stop&quot; button
  to the cell with the training loop.

  Clicking &quot;stop&quot; will halt the training loop.
  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">kino_early_stop</span><span class="p" data-group-id="6921893243-2">(</span><span class="n">loop</span><span class="p" data-group-id="6921893243-2">)</span><span class="w"> </span><span class="k" data-group-id="6921893243-3">do</span><span class="w">
    </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Kino.Frame</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="6921893243-4">(</span><span class="p" data-group-id="6921893243-4">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="6921893243-5">(</span><span class="p" data-group-id="6921893243-5">)</span><span class="w">
    </span><span class="n">stop_button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Kino.Control</span><span class="o">.</span><span class="n">button</span><span class="p" data-group-id="6921893243-6">(</span><span class="s">&quot;stop&quot;</span><span class="p" data-group-id="6921893243-6">)</span><span class="w">
    </span><span class="nc">Kino.Frame</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="6921893243-7">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">stop_button</span><span class="p" data-group-id="6921893243-7">)</span><span class="w">

    </span><span class="p" data-group-id="6921893243-8">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">button_agent</span><span class="p" data-group-id="6921893243-8">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Agent</span><span class="o">.</span><span class="n">start_link</span><span class="p" data-group-id="6921893243-9">(</span><span class="k" data-group-id="6921893243-10">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="k" data-group-id="6921893243-10">end</span><span class="p" data-group-id="6921893243-9">)</span><span class="w">

    </span><span class="n">stop_button</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino.Control</span><span class="o">.</span><span class="n">stream</span><span class="p" data-group-id="6921893243-11">(</span><span class="p" data-group-id="6921893243-11">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino</span><span class="o">.</span><span class="n">listen</span><span class="p" data-group-id="6921893243-12">(</span><span class="k" data-group-id="6921893243-13">fn</span><span class="w"> </span><span class="c">_event</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">Agent</span><span class="o">.</span><span class="n">update</span><span class="p" data-group-id="6921893243-14">(</span><span class="n">button_agent</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="6921893243-15">fn</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="ss">:stop</span><span class="w"> </span><span class="k" data-group-id="6921893243-15">end</span><span class="p" data-group-id="6921893243-14">)</span><span class="w">
    </span><span class="k" data-group-id="6921893243-13">end</span><span class="p" data-group-id="6921893243-12">)</span><span class="w">

    </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="6921893243-16">fn</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">stop_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Agent</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="6921893243-17">(</span><span class="n">button_agent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="ni">&amp;1</span><span class="p" data-group-id="6921893243-17">)</span><span class="w">

      </span><span class="k">if</span><span class="w"> </span><span class="n">stop_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:stop</span><span class="w"> </span><span class="k" data-group-id="6921893243-18">do</span><span class="w">
        </span><span class="nc">Agent</span><span class="o">.</span><span class="n">stop</span><span class="p" data-group-id="6921893243-19">(</span><span class="n">button_agent</span><span class="p" data-group-id="6921893243-19">)</span><span class="w">
        </span><span class="nc">Kino.Frame</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="6921893243-20">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stopped&quot;</span><span class="p" data-group-id="6921893243-20">)</span><span class="w">
        </span><span class="p" data-group-id="6921893243-21">{</span><span class="ss">:halt_loop</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="6921893243-21">}</span><span class="w">
      </span><span class="k" data-group-id="6921893243-18">else</span><span class="w">
        </span><span class="p" data-group-id="6921893243-22">{</span><span class="ss">:continue</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="6921893243-22">}</span><span class="w">
      </span><span class="k" data-group-id="6921893243-18">end</span><span class="w">
    </span><span class="k" data-group-id="6921893243-16">end</span><span class="w">

    </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">handle</span><span class="p" data-group-id="6921893243-23">(</span><span class="n">loop</span><span class="p">,</span><span class="w"> </span><span class="ss">:iteration_completed</span><span class="p">,</span><span class="w"> </span><span class="n">handler</span><span class="p" data-group-id="6921893243-23">)</span><span class="w">
  </span><span class="k" data-group-id="6921893243-3">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Plots the training and validation losses using Kino and VegaLite.

  This *must* come after `Axon.Loop.validate`.
  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">plot_losses</span><span class="p" data-group-id="6921893243-24">(</span><span class="n">loop</span><span class="p" data-group-id="6921893243-24">)</span><span class="w"> </span><span class="k" data-group-id="6921893243-25">do</span><span class="w">
    </span><span class="n">vl_widget</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">Vl</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="6921893243-26">(</span><span class="ss">width</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="p">,</span><span class="w"> </span><span class="ss">height</span><span class="p">:</span><span class="w"> </span><span class="mi">400</span><span class="p" data-group-id="6921893243-26">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Vl</span><span class="o">.</span><span class="n">mark</span><span class="p" data-group-id="6921893243-27">(</span><span class="ss">:point</span><span class="p">,</span><span class="w"> </span><span class="ss">tooltip</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="6921893243-27">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Vl</span><span class="o">.</span><span class="n">encode_field</span><span class="p" data-group-id="6921893243-28">(</span><span class="ss">:x</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;epoch&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:ordinal</span><span class="p" data-group-id="6921893243-28">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Vl</span><span class="o">.</span><span class="n">encode_field</span><span class="p" data-group-id="6921893243-29">(</span><span class="ss">:y</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;loss&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:quantitative</span><span class="p" data-group-id="6921893243-29">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Vl</span><span class="o">.</span><span class="n">encode_field</span><span class="p" data-group-id="6921893243-30">(</span><span class="ss">:color</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;dataset&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:nominal</span><span class="p" data-group-id="6921893243-30">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino.VegaLite</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="6921893243-31">(</span><span class="p" data-group-id="6921893243-31">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="6921893243-32">(</span><span class="p" data-group-id="6921893243-32">)</span><span class="w">

    </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="6921893243-33">fn</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="p" data-group-id="6921893243-34">%</span><span class="nc" data-group-id="6921893243-34">Axon.Loop.State</span><span class="p" data-group-id="6921893243-34">{</span><span class="ss">metrics</span><span class="p">:</span><span class="w"> </span><span class="n">metrics</span><span class="p">,</span><span class="w"> </span><span class="ss">epoch</span><span class="p">:</span><span class="w"> </span><span class="n">epoch</span><span class="p" data-group-id="6921893243-34">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="w">
      </span><span class="n">loss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metrics</span><span class="p" data-group-id="6921893243-35">[</span><span class="s">&quot;loss&quot;</span><span class="p" data-group-id="6921893243-35">]</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_number</span><span class="p" data-group-id="6921893243-36">(</span><span class="p" data-group-id="6921893243-36">)</span><span class="w">
      </span><span class="n">val_loss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metrics</span><span class="p" data-group-id="6921893243-37">[</span><span class="s">&quot;validation_loss&quot;</span><span class="p" data-group-id="6921893243-37">]</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_number</span><span class="p" data-group-id="6921893243-38">(</span><span class="p" data-group-id="6921893243-38">)</span><span class="w">

      </span><span class="n">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6921893243-39">[</span><span class="w">
        </span><span class="p" data-group-id="6921893243-40">%{</span><span class="ss">epoch</span><span class="p">:</span><span class="w"> </span><span class="n">epoch</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="n">loss</span><span class="p">,</span><span class="w"> </span><span class="ss">dataset</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;train&quot;</span><span class="p" data-group-id="6921893243-40">}</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="6921893243-41">%{</span><span class="ss">epoch</span><span class="p">:</span><span class="w"> </span><span class="n">epoch</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="n">val_loss</span><span class="p">,</span><span class="w"> </span><span class="ss">dataset</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;validation&quot;</span><span class="p" data-group-id="6921893243-41">}</span><span class="w">
      </span><span class="p" data-group-id="6921893243-39">]</span><span class="w">

      </span><span class="nc">Kino.VegaLite</span><span class="o">.</span><span class="n">push_many</span><span class="p" data-group-id="6921893243-42">(</span><span class="n">vl_widget</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="p" data-group-id="6921893243-42">)</span><span class="w">
      </span><span class="p" data-group-id="6921893243-43">{</span><span class="ss">:continue</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="6921893243-43">}</span><span class="w">
    </span><span class="k" data-group-id="6921893243-33">end</span><span class="w">

    </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">handle</span><span class="p" data-group-id="6921893243-44">(</span><span class="n">loop</span><span class="p">,</span><span class="w"> </span><span class="ss">:epoch_completed</span><span class="p">,</span><span class="w"> </span><span class="n">handler</span><span class="p" data-group-id="6921893243-44">)</span><span class="w">
  </span><span class="k" data-group-id="6921893243-25">end</span><span class="w">
</span><span class="k" data-group-id="6921893243-1">end</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="c1"># A helper function to display the input and output side by side</span><span class="w">
</span><span class="n">combined_input_output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="5970636470-1">fn</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">image_index</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="n">test_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_images</span><span class="p" data-group-id="5970636470-2">[</span><span class="p" data-group-id="5970636470-3">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="n">image_index</span><span class="p" data-group-id="5970636470-3">]</span><span class="p" data-group-id="5970636470-2">]</span><span class="w">
  </span><span class="n">reconstructed_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="5970636470-4">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">test_image</span><span class="p" data-group-id="5970636470-4">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">squeeze</span><span class="p" data-group-id="5970636470-5">(</span><span class="ss">axes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5970636470-6">[</span><span class="mi">0</span><span class="p" data-group-id="5970636470-6">]</span><span class="p" data-group-id="5970636470-5">)</span><span class="w">
  </span><span class="nc">Nx</span><span class="o">.</span><span class="n">concatenate</span><span class="p" data-group-id="5970636470-7">(</span><span class="p" data-group-id="5970636470-8">[</span><span class="n">test_image</span><span class="p">,</span><span class="w"> </span><span class="n">reconstructed_image</span><span class="p" data-group-id="5970636470-8">]</span><span class="p">,</span><span class="w"> </span><span class="ss">axis</span><span class="p">:</span><span class="w"> </span><span class="ss">:width</span><span class="p" data-group-id="5970636470-7">)</span><span class="w">
</span><span class="k" data-group-id="5970636470-1">end</span><span class="w">

</span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Kino.Frame</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="5970636470-9">(</span><span class="p" data-group-id="5970636470-9">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="5970636470-10">(</span><span class="p" data-group-id="5970636470-10">)</span><span class="w">

</span><span class="n">render_example_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="5970636470-11">fn</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="c1"># state.step_state[:model_state] contains the model params when this event is fired</span><span class="w">
  </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">step_state</span><span class="p" data-group-id="5970636470-12">[</span><span class="ss">:model_state</span><span class="p" data-group-id="5970636470-12">]</span><span class="w">
  </span><span class="n">image_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">random</span><span class="p" data-group-id="5970636470-13">(</span><span class="mi">0</span><span class="o">..</span><span class="p" data-group-id="5970636470-14">(</span><span class="nc">Nx</span><span class="o">.</span><span class="n">axis_size</span><span class="p" data-group-id="5970636470-15">(</span><span class="n">test_images</span><span class="p">,</span><span class="w"> </span><span class="ss">:images</span><span class="p" data-group-id="5970636470-15">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="5970636470-14">)</span><span class="p" data-group-id="5970636470-13">)</span><span class="w">
  </span><span class="n">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">combined_input_output</span><span class="o">.</span><span class="p" data-group-id="5970636470-16">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">image_index</span><span class="p" data-group-id="5970636470-16">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Data</span><span class="o">.</span><span class="n">image_to_kino</span><span class="p" data-group-id="5970636470-17">(</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">400</span><span class="p" data-group-id="5970636470-17">)</span><span class="w">
  </span><span class="nc">Kino.Frame</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="5970636470-18">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p" data-group-id="5970636470-18">)</span><span class="w">
  </span><span class="nc">Kino.Frame</span><span class="o">.</span><span class="n">append</span><span class="p" data-group-id="5970636470-19">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Epoch: </span><span class="si" data-group-id="5970636470-20">#{</span><span class="n">state</span><span class="o">.</span><span class="n">epoch</span><span class="si" data-group-id="5970636470-20">}</span><span class="s">, Iteration: </span><span class="si" data-group-id="5970636470-21">#{</span><span class="n">state</span><span class="o">.</span><span class="n">iteration</span><span class="si" data-group-id="5970636470-21">}</span><span class="s">&quot;</span><span class="p" data-group-id="5970636470-19">)</span><span class="w">
  </span><span class="p" data-group-id="5970636470-22">{</span><span class="ss">:continue</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="5970636470-22">}</span><span class="w">
</span><span class="k" data-group-id="5970636470-11">end</span><span class="w">

</span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">model</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">trainer</span><span class="p" data-group-id="5970636470-23">(</span><span class="ss">:mean_squared_error</span><span class="p">,</span><span class="w"> </span><span class="nc">Axon.Optimizers</span><span class="o">.</span><span class="n">adamw</span><span class="p" data-group-id="5970636470-24">(</span><span class="mf">0.001</span><span class="p" data-group-id="5970636470-24">)</span><span class="p" data-group-id="5970636470-23">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">KinoAxon</span><span class="o">.</span><span class="n">kino_early_stop</span><span class="p" data-group-id="5970636470-25">(</span><span class="p" data-group-id="5970636470-25">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">handle</span><span class="p" data-group-id="5970636470-26">(</span><span class="ss">:iteration_completed</span><span class="p">,</span><span class="w"> </span><span class="n">render_example_handler</span><span class="p">,</span><span class="w"> </span><span class="ss">every</span><span class="p">:</span><span class="w"> </span><span class="mi">450</span><span class="p" data-group-id="5970636470-26">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">validate</span><span class="p" data-group-id="5970636470-27">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">test_data</span><span class="p" data-group-id="5970636470-27">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">KinoAxon</span><span class="o">.</span><span class="n">plot_losses</span><span class="p" data-group-id="5970636470-28">(</span><span class="p" data-group-id="5970636470-28">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="5970636470-29">(</span><span class="n">train_data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5970636470-30">%{</span><span class="p" data-group-id="5970636470-30">}</span><span class="p">,</span><span class="w"> </span><span class="ss">epochs</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="ss">compiler</span><span class="p">:</span><span class="w"> </span><span class="nc">EXLA</span><span class="p" data-group-id="5970636470-29">)</span><span class="w">

</span><span class="ss">:ok</span></code></pre><h2 id="splitting-up-the-model" class="section-heading">
  <a href="#splitting-up-the-model" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">splitting-up-the-model</p>
  </a>
  Splitting up the model
</h2>
<p>Cool! We now have the parameters for a trained, simple autoencoder. Our next step is to split up the model so we can use the encoder and decoder separately. By doing that, we'll be able to take an image and <em>encode</em> it to get the model's compressed image representation (the latent vector). We can then manipulate the latent vector and run the manipulated latent vector through the <em>decoder</em> to get a new image.</p><p>Let's start by defining the encoder and decoder separately as two different models.</p><pre><code class="makeup elixir" translate="no"><span class="n">encoder</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Axon</span><span class="o">.</span><span class="n">input</span><span class="p" data-group-id="7032421386-1">(</span><span class="s">&quot;image&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">shape</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7032421386-2">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="7032421386-2">}</span><span class="p" data-group-id="7032421386-1">)</span><span class="w">
  </span><span class="c1"># This is now 28*28*1 = 784</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">flatten</span><span class="p" data-group-id="7032421386-3">(</span><span class="p" data-group-id="7032421386-3">)</span><span class="w">
  </span><span class="c1"># The encoder</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="7032421386-4">(</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;encoder_layer_1&quot;</span><span class="p" data-group-id="7032421386-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="7032421386-5">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;encoder_layer_2&quot;</span><span class="p" data-group-id="7032421386-5">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="7032421386-6">(</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;encoder_layer_3&quot;</span><span class="p" data-group-id="7032421386-6">)</span><span class="w">
  </span><span class="c1"># Bottleneck layer</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="7032421386-7">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bottleneck_layer&quot;</span><span class="p" data-group-id="7032421386-7">)</span><span class="w">

</span><span class="c1"># The output from the encoder</span><span class="w">
</span><span class="n">decoder</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Axon</span><span class="o">.</span><span class="n">input</span><span class="p" data-group-id="7032421386-8">(</span><span class="s">&quot;latent&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">shape</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7032421386-9">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="7032421386-9">}</span><span class="p" data-group-id="7032421386-8">)</span><span class="w">
  </span><span class="c1"># The decoder</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="7032421386-10">(</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;decoder_layer_1&quot;</span><span class="p" data-group-id="7032421386-10">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="7032421386-11">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;decoder_layer_2&quot;</span><span class="p" data-group-id="7032421386-11">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="7032421386-12">(</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;decoder_layer_3&quot;</span><span class="p" data-group-id="7032421386-12">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="7032421386-13">(</span><span class="mi">784</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:sigmoid</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;decoder_layer_4&quot;</span><span class="p" data-group-id="7032421386-13">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">CustomLayer</span><span class="o">.</span><span class="n">scaling_layer</span><span class="p" data-group-id="7032421386-14">(</span><span class="p" data-group-id="7032421386-14">)</span><span class="w">
  </span><span class="c1"># Turn it back into a 28x28 single channel image</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="7032421386-15">(</span><span class="p" data-group-id="7032421386-16">{</span><span class="ss">:auto</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="7032421386-16">}</span><span class="p" data-group-id="7032421386-15">)</span><span class="w">

</span><span class="nc">Axon.Display</span><span class="o">.</span><span class="n">as_table</span><span class="p" data-group-id="7032421386-17">(</span><span class="n">encoder</span><span class="p">,</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">template</span><span class="p" data-group-id="7032421386-18">(</span><span class="p" data-group-id="7032421386-19">{</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="7032421386-19">}</span><span class="p">,</span><span class="w"> </span><span class="ss">:f32</span><span class="p" data-group-id="7032421386-18">)</span><span class="p" data-group-id="7032421386-17">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="7032421386-20">(</span><span class="p" data-group-id="7032421386-20">)</span><span class="w">
</span><span class="nc">Axon.Display</span><span class="o">.</span><span class="n">as_table</span><span class="p" data-group-id="7032421386-21">(</span><span class="n">decoder</span><span class="p">,</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">template</span><span class="p" data-group-id="7032421386-22">(</span><span class="p" data-group-id="7032421386-23">{</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="7032421386-23">}</span><span class="p">,</span><span class="w"> </span><span class="ss">:f32</span><span class="p" data-group-id="7032421386-22">)</span><span class="p" data-group-id="7032421386-21">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="7032421386-24">(</span><span class="p" data-group-id="7032421386-24">)</span></code></pre><p>We have the two models, but the problem is these are untrained models so we don't have the corresponding set of parameters. We'd like to use the parameters from the autoencoder we just trained and apply them to our split up models.</p><p>Let's first take a look at what params actually are:</p><pre><code class="makeup elixir" translate="no"><span class="n">params</span></code></pre><p>Params are just a <a href="https://hexdocs.pm/elixir/Map.html"><code class="inline">Map</code></a> with the layer name as the key identifying which parameters to use. We can easily match up the layer names with the output from the <a href="Axon.Display.html#as_table/2"><code class="inline">Axon.Display.as_table/2</code></a> call for the autoencoder model.</p><p>So all we need to do is create a new Map that plucks out the right layers from our autoencoder <code class="inline">params</code> for each model and use that to run inference on our split up models.</p><p>Fortunately, since we gave each of the layers names, this requires no work at all - we can use the Map as it is since the layer names match up! Axon will ignore any extra keys so those won't be a problem.</p><p>Note that naming the layers wasn't <em>required</em>, if the layers didn't have names we would have some renaming to do to get the names to match between the models. But giving them names made it very convenient :)</p><p>Let's try encoding an image, printing the latent and then decoding the latent using our split up model to make sure it's working.</p><pre><code class="makeup elixir" translate="no"><span class="n">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_images</span><span class="p" data-group-id="0096479059-1">[</span><span class="p" data-group-id="0096479059-2">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="0096479059-2">]</span><span class="p" data-group-id="0096479059-1">]</span><span class="w">

</span><span class="c1"># Encode the image</span><span class="w">
</span><span class="n">latent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="0096479059-3">(</span><span class="n">encoder</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p" data-group-id="0096479059-3">)</span><span class="w">
</span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="0096479059-4">(</span><span class="n">latent</span><span class="p">,</span><span class="w"> </span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Latent&quot;</span><span class="p" data-group-id="0096479059-4">)</span><span class="w">
</span><span class="c1"># Decode the image</span><span class="w">
</span><span class="n">reconstructed_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="0096479059-5">(</span><span class="n">decoder</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">latent</span><span class="p" data-group-id="0096479059-5">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">squeeze</span><span class="p" data-group-id="0096479059-6">(</span><span class="ss">axes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0096479059-7">[</span><span class="mi">0</span><span class="p" data-group-id="0096479059-7">]</span><span class="p" data-group-id="0096479059-6">)</span><span class="w">

</span><span class="n">combined_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">concatenate</span><span class="p" data-group-id="0096479059-8">(</span><span class="p" data-group-id="0096479059-9">[</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">reconstructed_image</span><span class="p" data-group-id="0096479059-9">]</span><span class="p">,</span><span class="w"> </span><span class="ss">axis</span><span class="p">:</span><span class="w"> </span><span class="ss">:width</span><span class="p" data-group-id="0096479059-8">)</span><span class="w">
</span><span class="nc">Data</span><span class="o">.</span><span class="n">image_to_kino</span><span class="p" data-group-id="0096479059-10">(</span><span class="n">combined_image</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">400</span><span class="p" data-group-id="0096479059-10">)</span></code></pre><p>Perfect! Seems like the split up models are working as expected. Now let's try to generate some new images using our autoencoder. To do this, we'll manipulate the latent so it's slightly different from what the encoder gave us. Specifically, we'll try to interpolate between two images, showing 100 steps from our starting image to our final image.</p><pre><code class="makeup elixir" translate="no"><span class="n">num_steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w">

</span><span class="c1"># Get our latents, image at index 0 is our starting point</span><span class="w">
</span><span class="c1"># index 1 is where we&#39;ll end</span><span class="w">
</span><span class="n">latents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="0872466226-1">(</span><span class="n">encoder</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">test_images</span><span class="p" data-group-id="0872466226-2">[</span><span class="p" data-group-id="0872466226-3">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">1</span><span class="p" data-group-id="0872466226-3">]</span><span class="p" data-group-id="0872466226-2">]</span><span class="p" data-group-id="0872466226-1">)</span><span class="w">
</span><span class="c1"># Latents is a {2, 10} tensor</span><span class="w">
</span><span class="c1"># The step we&#39;ll add to our latent to move it towards image[1]</span><span class="w">
</span><span class="n">step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">subtract</span><span class="p" data-group-id="0872466226-4">(</span><span class="n">latents</span><span class="p" data-group-id="0872466226-5">[</span><span class="mi">1</span><span class="p" data-group-id="0872466226-5">]</span><span class="p">,</span><span class="w"> </span><span class="n">latents</span><span class="p" data-group-id="0872466226-6">[</span><span class="mi">0</span><span class="p" data-group-id="0872466226-6">]</span><span class="p" data-group-id="0872466226-4">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">divide</span><span class="p" data-group-id="0872466226-7">(</span><span class="n">num_steps</span><span class="p" data-group-id="0872466226-7">)</span><span class="w">
</span><span class="c1"># We can make a batch of all our new latents</span><span class="w">
</span><span class="n">new_latents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">multiply</span><span class="p" data-group-id="0872466226-8">(</span><span class="nc">Nx</span><span class="o">.</span><span class="n">iota</span><span class="p" data-group-id="0872466226-9">(</span><span class="p" data-group-id="0872466226-10">{</span><span class="n">num_steps</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="0872466226-10">}</span><span class="p" data-group-id="0872466226-9">)</span><span class="p">,</span><span class="w"> </span><span class="n">step</span><span class="p" data-group-id="0872466226-8">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">add</span><span class="p" data-group-id="0872466226-11">(</span><span class="n">latents</span><span class="p" data-group-id="0872466226-12">[</span><span class="mi">0</span><span class="p" data-group-id="0872466226-12">]</span><span class="p" data-group-id="0872466226-11">)</span><span class="w">

</span><span class="n">reconstructed_images</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="0872466226-13">(</span><span class="n">decoder</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">new_latents</span><span class="p" data-group-id="0872466226-13">)</span><span class="w">

</span><span class="n">reconstructed_images</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="0872466226-14">(</span><span class="w">
    </span><span class="n">reconstructed_images</span><span class="p">,</span><span class="w">
    </span><span class="nc">Nx</span><span class="o">.</span><span class="n">shape</span><span class="p" data-group-id="0872466226-15">(</span><span class="n">reconstructed_images</span><span class="p" data-group-id="0872466226-15">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">names</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0872466226-16">[</span><span class="ss">:images</span><span class="p">,</span><span class="w"> </span><span class="ss">:channels</span><span class="p">,</span><span class="w"> </span><span class="ss">:height</span><span class="p">,</span><span class="w"> </span><span class="ss">:width</span><span class="p" data-group-id="0872466226-16">]</span><span class="w">
  </span><span class="p" data-group-id="0872466226-14">)</span><span class="w">

</span><span class="nc">Stream</span><span class="o">.</span><span class="n">interval</span><span class="p" data-group-id="0872466226-17">(</span><span class="n">div</span><span class="p" data-group-id="0872466226-18">(</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="n">num_steps</span><span class="p" data-group-id="0872466226-18">)</span><span class="p" data-group-id="0872466226-17">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">take</span><span class="p" data-group-id="0872466226-19">(</span><span class="n">num_steps</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="0872466226-19">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino</span><span class="o">.</span><span class="n">animate</span><span class="p" data-group-id="0872466226-20">(</span><span class="k" data-group-id="0872466226-21">fn</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="nc">Data</span><span class="o">.</span><span class="n">image_to_kino</span><span class="p" data-group-id="0872466226-22">(</span><span class="n">reconstructed_images</span><span class="p" data-group-id="0872466226-23">[</span><span class="n">i</span><span class="p" data-group-id="0872466226-23">]</span><span class="p" data-group-id="0872466226-22">)</span><span class="w">
</span><span class="k" data-group-id="0872466226-21">end</span><span class="p" data-group-id="0872466226-20">)</span></code></pre><p>Cool! We have interpolation! But did you notice that some of the intermediate frames don't look fashionable at all? Autoencoders don't generally return good results for random vectors in their latent space. That's where a VAE can help.</p><h2 id="making-it-variational" class="section-heading">
  <a href="#making-it-variational" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">making-it-variational</p>
  </a>
  Making it variational
</h2>
<p>In a VAE, instead of outputting a latent vector, our encoder will output a distribution. Essentially this means instead of 10 outputs we'll have 20. 10 of them will represent the mean and 10 will represent the log of the variance of the latent. We'll have to sample from this distribution to get our latent vector. Finally, we'll have to modify our loss function to also compute the KL Divergence between the latent distribution and a standard normal distribution (this acts as a regularizer of the latent space).</p><p>We'll start by defining our model:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Vae</span><span class="w"> </span><span class="k" data-group-id="3874174256-1">do</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Nx.Defn</span><span class="w">

  </span><span class="na">@latent_features</span><span class="w"> </span><span class="mi">10</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">sampling_layer</span><span class="p" data-group-id="3874174256-2">(</span><span class="p" data-group-id="3874174256-3">%</span><span class="nc" data-group-id="3874174256-3">Axon</span><span class="p" data-group-id="3874174256-3">{</span><span class="p" data-group-id="3874174256-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="c">_opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="3874174256-4">[</span><span class="p" data-group-id="3874174256-4">]</span><span class="p" data-group-id="3874174256-2">)</span><span class="w"> </span><span class="k" data-group-id="3874174256-5">do</span><span class="w">
    </span><span class="nc">Axon</span><span class="o">.</span><span class="n">layer</span><span class="p" data-group-id="3874174256-6">(</span><span class="o">&amp;</span><span class="n">sampling_layer_impl</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3874174256-7">[</span><span class="n">input</span><span class="p" data-group-id="3874174256-7">]</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;sampling_layer&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">op_name</span><span class="p">:</span><span class="w"> </span><span class="ss">:sample</span><span class="p" data-group-id="3874174256-6">)</span><span class="w">
  </span><span class="k" data-group-id="3874174256-5">end</span><span class="w">

  </span><span class="kd">defnp</span><span class="w"> </span><span class="nf">sampling_layer_impl</span><span class="p" data-group-id="3874174256-8">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="c">_opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="3874174256-9">[</span><span class="p" data-group-id="3874174256-9">]</span><span class="p" data-group-id="3874174256-8">)</span><span class="w"> </span><span class="k" data-group-id="3874174256-10">do</span><span class="w">
    </span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p" data-group-id="3874174256-11">[</span><span class="p" data-group-id="3874174256-12">[</span><span class="mi">0</span><span class="o">..</span><span class="o">-</span><span class="mi">1</span><span class="o">//</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="o">-</span><span class="mi">1</span><span class="o">//</span><span class="mi">1</span><span class="p" data-group-id="3874174256-12">]</span><span class="p" data-group-id="3874174256-11">]</span><span class="w">
    </span><span class="n">log_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p" data-group-id="3874174256-13">[</span><span class="p" data-group-id="3874174256-14">[</span><span class="mi">0</span><span class="o">..</span><span class="o">-</span><span class="mi">1</span><span class="o">//</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="o">-</span><span class="mi">1</span><span class="o">//</span><span class="mi">1</span><span class="p" data-group-id="3874174256-14">]</span><span class="p" data-group-id="3874174256-13">]</span><span class="w">
    </span><span class="n">std_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">exp</span><span class="p" data-group-id="3874174256-15">(</span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">log_var</span><span class="p" data-group-id="3874174256-15">)</span><span class="w">
    </span><span class="n">eps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">random_normal</span><span class="p" data-group-id="3874174256-16">(</span><span class="n">std_dev</span><span class="p" data-group-id="3874174256-16">)</span><span class="w">
    </span><span class="n">sample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mu</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std_dev</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">eps</span><span class="w">
    </span><span class="nc">Nx</span><span class="o">.</span><span class="n">stack</span><span class="p" data-group-id="3874174256-17">(</span><span class="p" data-group-id="3874174256-18">[</span><span class="n">sample</span><span class="p">,</span><span class="w"> </span><span class="n">mu</span><span class="p">,</span><span class="w"> </span><span class="n">std_dev</span><span class="p" data-group-id="3874174256-18">]</span><span class="p">,</span><span class="w"> </span><span class="ss">axis</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="3874174256-17">)</span><span class="w">
  </span><span class="k" data-group-id="3874174256-10">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">encoder_partial</span><span class="p" data-group-id="3874174256-19">(</span><span class="p" data-group-id="3874174256-19">)</span><span class="w"> </span><span class="k" data-group-id="3874174256-20">do</span><span class="w">
    </span><span class="nc">Axon</span><span class="o">.</span><span class="n">input</span><span class="p" data-group-id="3874174256-21">(</span><span class="s">&quot;image&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">shape</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3874174256-22">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="3874174256-22">}</span><span class="p" data-group-id="3874174256-21">)</span><span class="w">
    </span><span class="c1"># This is now 28*28*1 = 784</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">flatten</span><span class="p" data-group-id="3874174256-23">(</span><span class="p" data-group-id="3874174256-23">)</span><span class="w">
    </span><span class="c1"># The encoder</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="3874174256-24">(</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;encoder_layer_1&quot;</span><span class="p" data-group-id="3874174256-24">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="3874174256-25">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;encoder_layer_2&quot;</span><span class="p" data-group-id="3874174256-25">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="3874174256-26">(</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;encoder_layer_3&quot;</span><span class="p" data-group-id="3874174256-26">)</span><span class="w">
    </span><span class="c1"># Bottleneck layer</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="3874174256-27">(</span><span class="na">@latent_features</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bottleneck_layer&quot;</span><span class="p" data-group-id="3874174256-27">)</span><span class="w">
    </span><span class="c1"># Split up the mu and logvar</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="3874174256-28">(</span><span class="p" data-group-id="3874174256-29">{</span><span class="ss">:auto</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="na">@latent_features</span><span class="p" data-group-id="3874174256-29">}</span><span class="p" data-group-id="3874174256-28">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">sampling_layer</span><span class="p" data-group-id="3874174256-30">(</span><span class="p" data-group-id="3874174256-30">)</span><span class="w">
  </span><span class="k" data-group-id="3874174256-20">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">encoder</span><span class="p" data-group-id="3874174256-31">(</span><span class="p" data-group-id="3874174256-31">)</span><span class="w"> </span><span class="k" data-group-id="3874174256-32">do</span><span class="w">
    </span><span class="n">encoder_partial</span><span class="p" data-group-id="3874174256-33">(</span><span class="p" data-group-id="3874174256-33">)</span><span class="w">
    </span><span class="c1"># Grab only the sample (ie. the sampled latent)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">nx</span><span class="p" data-group-id="3874174256-34">(</span><span class="k" data-group-id="3874174256-35">fn</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="p" data-group-id="3874174256-36">[</span><span class="p" data-group-id="3874174256-37">[</span><span class="mi">0</span><span class="o">..</span><span class="o">-</span><span class="mi">1</span><span class="o">//</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="3874174256-37">]</span><span class="p" data-group-id="3874174256-36">]</span><span class="w"> </span><span class="k" data-group-id="3874174256-35">end</span><span class="p" data-group-id="3874174256-34">)</span><span class="w">
  </span><span class="k" data-group-id="3874174256-32">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">decoder</span><span class="p" data-group-id="3874174256-38">(</span><span class="n">input_latent</span><span class="p" data-group-id="3874174256-38">)</span><span class="w"> </span><span class="k" data-group-id="3874174256-39">do</span><span class="w">
    </span><span class="n">input_latent</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="3874174256-40">(</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;decoder_layer_1&quot;</span><span class="p" data-group-id="3874174256-40">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="3874174256-41">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;decoder_layer_2&quot;</span><span class="p" data-group-id="3874174256-41">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="3874174256-42">(</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;decoder_layer_3&quot;</span><span class="p" data-group-id="3874174256-42">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="3874174256-43">(</span><span class="mi">784</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:sigmoid</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;decoder_layer_4&quot;</span><span class="p" data-group-id="3874174256-43">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">CustomLayer</span><span class="o">.</span><span class="n">scaling_layer</span><span class="p" data-group-id="3874174256-44">(</span><span class="p" data-group-id="3874174256-44">)</span><span class="w">
    </span><span class="c1"># Turn it back into a 28x28 single channel image</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="3874174256-45">(</span><span class="p" data-group-id="3874174256-46">{</span><span class="ss">:auto</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="3874174256-46">}</span><span class="p" data-group-id="3874174256-45">)</span><span class="w">
  </span><span class="k" data-group-id="3874174256-39">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">autoencoder</span><span class="p" data-group-id="3874174256-47">(</span><span class="p" data-group-id="3874174256-47">)</span><span class="w"> </span><span class="k" data-group-id="3874174256-48">do</span><span class="w">
    </span><span class="n">encoder_partial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encoder_partial</span><span class="p" data-group-id="3874174256-49">(</span><span class="p" data-group-id="3874174256-49">)</span><span class="w">
    </span><span class="n">encoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encoder</span><span class="p" data-group-id="3874174256-50">(</span><span class="p" data-group-id="3874174256-50">)</span><span class="w">
    </span><span class="n">autoencoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decoder</span><span class="p" data-group-id="3874174256-51">(</span><span class="n">encoder</span><span class="p" data-group-id="3874174256-51">)</span><span class="w">
    </span><span class="nc">Axon</span><span class="o">.</span><span class="n">container</span><span class="p" data-group-id="3874174256-52">(</span><span class="p" data-group-id="3874174256-53">%{</span><span class="ss">mu_sigma</span><span class="p">:</span><span class="w"> </span><span class="n">encoder_partial</span><span class="p">,</span><span class="w"> </span><span class="ss">reconstruction</span><span class="p">:</span><span class="w"> </span><span class="n">autoencoder</span><span class="p" data-group-id="3874174256-53">}</span><span class="p" data-group-id="3874174256-52">)</span><span class="w">
  </span><span class="k" data-group-id="3874174256-48">end</span><span class="w">
</span><span class="k" data-group-id="3874174256-1">end</span></code></pre><p>There's a few interesting things going on here. First, since our model has become more complex, we've used a module to keep it organized. We also built a custom layer to do the sampling and output the sampled latent vector as well as the distribution parameters (mu and sigma).</p><p>Finally, we need the distribution itself so we can calculate the KL Divergence in our loss function. To make the model output the distribution parameters (mu and sigma), we use <a href="Axon.html#container/1"><code class="inline">Axon.container/1</code></a> to produce two outputs from our model instead of one. Now, instead of getting a tensor as an output, we'll get a map with the two tensors we need for our loss function.</p><p>Our loss function also has to be modified so be the sum of the KL divergence and MSE. Here's our custom loss function:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">CustomLoss</span><span class="w"> </span><span class="k" data-group-id="1857350857-1">do</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Nx.Defn</span><span class="w">

  </span><span class="kd">defn</span><span class="w"> </span><span class="nf">loss</span><span class="p" data-group-id="1857350857-2">(</span><span class="n">y_true</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1857350857-3">%{</span><span class="ss">reconstruction</span><span class="p">:</span><span class="w"> </span><span class="n">reconstruction</span><span class="p">,</span><span class="w"> </span><span class="ss">mu_sigma</span><span class="p">:</span><span class="w"> </span><span class="n">mu_sigma</span><span class="p" data-group-id="1857350857-3">}</span><span class="p" data-group-id="1857350857-2">)</span><span class="w"> </span><span class="k" data-group-id="1857350857-4">do</span><span class="w">
    </span><span class="n">mu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mu_sigma</span><span class="p" data-group-id="1857350857-5">[</span><span class="p" data-group-id="1857350857-6">[</span><span class="mi">0</span><span class="o">..</span><span class="o">-</span><span class="mi">1</span><span class="o">//</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="o">-</span><span class="mi">1</span><span class="o">//</span><span class="mi">1</span><span class="p" data-group-id="1857350857-6">]</span><span class="p" data-group-id="1857350857-5">]</span><span class="w">
    </span><span class="n">sigma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mu_sigma</span><span class="p" data-group-id="1857350857-7">[</span><span class="p" data-group-id="1857350857-8">[</span><span class="mi">0</span><span class="o">..</span><span class="o">-</span><span class="mi">1</span><span class="o">//</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="o">-</span><span class="mi">1</span><span class="o">//</span><span class="mi">1</span><span class="p" data-group-id="1857350857-8">]</span><span class="p" data-group-id="1857350857-7">]</span><span class="w">
    </span><span class="n">kld</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">sum</span><span class="p" data-group-id="1857350857-9">(</span><span class="o">-</span><span class="nc">Nx</span><span class="o">.</span><span class="n">log</span><span class="p" data-group-id="1857350857-10">(</span><span class="n">sigma</span><span class="p" data-group-id="1857350857-10">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">multiply</span><span class="p" data-group-id="1857350857-11">(</span><span class="n">sigma</span><span class="p">,</span><span class="w"> </span><span class="n">sigma</span><span class="p" data-group-id="1857350857-11">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">multiply</span><span class="p" data-group-id="1857350857-12">(</span><span class="n">mu</span><span class="p">,</span><span class="w"> </span><span class="n">mu</span><span class="p" data-group-id="1857350857-12">)</span><span class="p" data-group-id="1857350857-9">)</span><span class="w">
    </span><span class="n">kld</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Axon.Losses</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p" data-group-id="1857350857-13">(</span><span class="n">y_true</span><span class="p">,</span><span class="w"> </span><span class="n">reconstruction</span><span class="p">,</span><span class="w"> </span><span class="ss">reduction</span><span class="p">:</span><span class="w"> </span><span class="ss">:sum</span><span class="p" data-group-id="1857350857-13">)</span><span class="w">
  </span><span class="k" data-group-id="1857350857-4">end</span><span class="w">
</span><span class="k" data-group-id="1857350857-1">end</span></code></pre><p>With all our pieces ready, we can pretty much use the same training loop as we did earlier. The only modifications needed are to account for the fact that the model outputs a map with two values instead of a single tensor and telling the trainer to use our custom loss.</p><pre><code class="makeup elixir" translate="no"><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vae</span><span class="o">.</span><span class="n">autoencoder</span><span class="p" data-group-id="2778402458-1">(</span><span class="p" data-group-id="2778402458-1">)</span><span class="w">

</span><span class="c1"># A helper function to display the input and output side by side</span><span class="w">
</span><span class="n">combined_input_output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="2778402458-2">fn</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">image_index</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="n">test_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_images</span><span class="p" data-group-id="2778402458-3">[</span><span class="p" data-group-id="2778402458-4">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="n">image_index</span><span class="p" data-group-id="2778402458-4">]</span><span class="p" data-group-id="2778402458-3">]</span><span class="w">
  </span><span class="p" data-group-id="2778402458-5">%{</span><span class="ss">reconstruction</span><span class="p">:</span><span class="w"> </span><span class="n">reconstructed_image</span><span class="p" data-group-id="2778402458-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="2778402458-6">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">test_image</span><span class="p" data-group-id="2778402458-6">)</span><span class="w">
  </span><span class="n">reconstructed_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reconstructed_image</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">squeeze</span><span class="p" data-group-id="2778402458-7">(</span><span class="ss">axes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2778402458-8">[</span><span class="mi">0</span><span class="p" data-group-id="2778402458-8">]</span><span class="p" data-group-id="2778402458-7">)</span><span class="w">
  </span><span class="nc">Nx</span><span class="o">.</span><span class="n">concatenate</span><span class="p" data-group-id="2778402458-9">(</span><span class="p" data-group-id="2778402458-10">[</span><span class="n">test_image</span><span class="p">,</span><span class="w"> </span><span class="n">reconstructed_image</span><span class="p" data-group-id="2778402458-10">]</span><span class="p">,</span><span class="w"> </span><span class="ss">axis</span><span class="p">:</span><span class="w"> </span><span class="ss">:width</span><span class="p" data-group-id="2778402458-9">)</span><span class="w">
</span><span class="k" data-group-id="2778402458-2">end</span><span class="w">

</span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Kino.Frame</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="2778402458-11">(</span><span class="p" data-group-id="2778402458-11">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="2778402458-12">(</span><span class="p" data-group-id="2778402458-12">)</span><span class="w">

</span><span class="n">render_example_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="2778402458-13">fn</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="c1"># state.step_state[:model_state] contains the model params when this event is fired</span><span class="w">
  </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">step_state</span><span class="p" data-group-id="2778402458-14">[</span><span class="ss">:model_state</span><span class="p" data-group-id="2778402458-14">]</span><span class="w">
  </span><span class="n">image_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">random</span><span class="p" data-group-id="2778402458-15">(</span><span class="mi">0</span><span class="o">..</span><span class="p" data-group-id="2778402458-16">(</span><span class="nc">Nx</span><span class="o">.</span><span class="n">axis_size</span><span class="p" data-group-id="2778402458-17">(</span><span class="n">test_images</span><span class="p">,</span><span class="w"> </span><span class="ss">:images</span><span class="p" data-group-id="2778402458-17">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="2778402458-16">)</span><span class="p" data-group-id="2778402458-15">)</span><span class="w">
  </span><span class="n">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">combined_input_output</span><span class="o">.</span><span class="p" data-group-id="2778402458-18">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">image_index</span><span class="p" data-group-id="2778402458-18">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Data</span><span class="o">.</span><span class="n">image_to_kino</span><span class="p" data-group-id="2778402458-19">(</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">400</span><span class="p" data-group-id="2778402458-19">)</span><span class="w">
  </span><span class="nc">Kino.Frame</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="2778402458-20">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p" data-group-id="2778402458-20">)</span><span class="w">
  </span><span class="nc">Kino.Frame</span><span class="o">.</span><span class="n">append</span><span class="p" data-group-id="2778402458-21">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Epoch: </span><span class="si" data-group-id="2778402458-22">#{</span><span class="n">state</span><span class="o">.</span><span class="n">epoch</span><span class="si" data-group-id="2778402458-22">}</span><span class="s">, Iteration: </span><span class="si" data-group-id="2778402458-23">#{</span><span class="n">state</span><span class="o">.</span><span class="n">iteration</span><span class="si" data-group-id="2778402458-23">}</span><span class="s">&quot;</span><span class="p" data-group-id="2778402458-21">)</span><span class="w">
  </span><span class="p" data-group-id="2778402458-24">{</span><span class="ss">:continue</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="2778402458-24">}</span><span class="w">
</span><span class="k" data-group-id="2778402458-13">end</span><span class="w">

</span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">model</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">trainer</span><span class="p" data-group-id="2778402458-25">(</span><span class="o">&amp;</span><span class="nc">CustomLoss</span><span class="o">.</span><span class="n">loss</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nc">Axon.Optimizers</span><span class="o">.</span><span class="n">adam</span><span class="p" data-group-id="2778402458-26">(</span><span class="mf">0.001</span><span class="p" data-group-id="2778402458-26">)</span><span class="p" data-group-id="2778402458-25">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">KinoAxon</span><span class="o">.</span><span class="n">kino_early_stop</span><span class="p" data-group-id="2778402458-27">(</span><span class="p" data-group-id="2778402458-27">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">handle</span><span class="p" data-group-id="2778402458-28">(</span><span class="ss">:epoch_completed</span><span class="p">,</span><span class="w"> </span><span class="n">render_example_handler</span><span class="p" data-group-id="2778402458-28">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">validate</span><span class="p" data-group-id="2778402458-29">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">test_data</span><span class="p" data-group-id="2778402458-29">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">KinoAxon</span><span class="o">.</span><span class="n">plot_losses</span><span class="p" data-group-id="2778402458-30">(</span><span class="p" data-group-id="2778402458-30">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="2778402458-31">(</span><span class="n">train_data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2778402458-32">%{</span><span class="p" data-group-id="2778402458-32">}</span><span class="p">,</span><span class="w"> </span><span class="ss">epochs</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="ss">compiler</span><span class="p">:</span><span class="w"> </span><span class="nc">EXLA</span><span class="p" data-group-id="2778402458-31">)</span><span class="w">

</span><span class="ss">:ok</span></code></pre><p>Finally, we can try our interpolation again:</p><pre><code class="makeup elixir" translate="no"><span class="n">num_steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w">

</span><span class="c1"># Get our latents, image at index 0 is our starting point</span><span class="w">
</span><span class="c1"># index 1 is where we&#39;ll end</span><span class="w">
</span><span class="n">latents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="8830596086-1">(</span><span class="nc">Vae</span><span class="o">.</span><span class="n">encoder</span><span class="p" data-group-id="8830596086-2">(</span><span class="p" data-group-id="8830596086-2">)</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">test_images</span><span class="p" data-group-id="8830596086-3">[</span><span class="p" data-group-id="8830596086-4">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">1</span><span class="p" data-group-id="8830596086-4">]</span><span class="p" data-group-id="8830596086-3">]</span><span class="p" data-group-id="8830596086-1">)</span><span class="w">
</span><span class="c1"># Latents is a {2, 10} tensor</span><span class="w">
</span><span class="c1"># The step we&#39;ll add to our latent to move it towards image[1]</span><span class="w">
</span><span class="n">step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">subtract</span><span class="p" data-group-id="8830596086-5">(</span><span class="n">latents</span><span class="p" data-group-id="8830596086-6">[</span><span class="mi">1</span><span class="p" data-group-id="8830596086-6">]</span><span class="p">,</span><span class="w"> </span><span class="n">latents</span><span class="p" data-group-id="8830596086-7">[</span><span class="mi">0</span><span class="p" data-group-id="8830596086-7">]</span><span class="p" data-group-id="8830596086-5">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">divide</span><span class="p" data-group-id="8830596086-8">(</span><span class="n">num_steps</span><span class="p" data-group-id="8830596086-8">)</span><span class="w">
</span><span class="c1"># We can make a batch of all our new latents</span><span class="w">
</span><span class="n">new_latents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">multiply</span><span class="p" data-group-id="8830596086-9">(</span><span class="nc">Nx</span><span class="o">.</span><span class="n">iota</span><span class="p" data-group-id="8830596086-10">(</span><span class="p" data-group-id="8830596086-11">{</span><span class="n">num_steps</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="8830596086-11">}</span><span class="p" data-group-id="8830596086-10">)</span><span class="p">,</span><span class="w"> </span><span class="n">step</span><span class="p" data-group-id="8830596086-9">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">add</span><span class="p" data-group-id="8830596086-12">(</span><span class="n">latents</span><span class="p" data-group-id="8830596086-13">[</span><span class="mi">0</span><span class="p" data-group-id="8830596086-13">]</span><span class="p" data-group-id="8830596086-12">)</span><span class="w">

</span><span class="n">decoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">input</span><span class="p" data-group-id="8830596086-14">(</span><span class="s">&quot;latent&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">shape</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8830596086-15">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="8830596086-15">}</span><span class="p" data-group-id="8830596086-14">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Vae</span><span class="o">.</span><span class="n">decoder</span><span class="p" data-group-id="8830596086-16">(</span><span class="p" data-group-id="8830596086-16">)</span><span class="w">

</span><span class="n">reconstructed_images</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="8830596086-17">(</span><span class="n">decoder</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">new_latents</span><span class="p" data-group-id="8830596086-17">)</span><span class="w">

</span><span class="n">reconstructed_images</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="8830596086-18">(</span><span class="w">
    </span><span class="n">reconstructed_images</span><span class="p">,</span><span class="w">
    </span><span class="nc">Nx</span><span class="o">.</span><span class="n">shape</span><span class="p" data-group-id="8830596086-19">(</span><span class="n">reconstructed_images</span><span class="p" data-group-id="8830596086-19">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">names</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8830596086-20">[</span><span class="ss">:images</span><span class="p">,</span><span class="w"> </span><span class="ss">:channels</span><span class="p">,</span><span class="w"> </span><span class="ss">:height</span><span class="p">,</span><span class="w"> </span><span class="ss">:width</span><span class="p" data-group-id="8830596086-20">]</span><span class="w">
  </span><span class="p" data-group-id="8830596086-18">)</span><span class="w">

</span><span class="nc">Stream</span><span class="o">.</span><span class="n">interval</span><span class="p" data-group-id="8830596086-21">(</span><span class="n">div</span><span class="p" data-group-id="8830596086-22">(</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="n">num_steps</span><span class="p" data-group-id="8830596086-22">)</span><span class="p" data-group-id="8830596086-21">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">take</span><span class="p" data-group-id="8830596086-23">(</span><span class="n">num_steps</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="8830596086-23">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino</span><span class="o">.</span><span class="n">animate</span><span class="p" data-group-id="8830596086-24">(</span><span class="k" data-group-id="8830596086-25">fn</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="nc">Data</span><span class="o">.</span><span class="n">image_to_kino</span><span class="p" data-group-id="8830596086-26">(</span><span class="n">reconstructed_images</span><span class="p" data-group-id="8830596086-27">[</span><span class="n">i</span><span class="p" data-group-id="8830596086-27">]</span><span class="p" data-group-id="8830596086-26">)</span><span class="w">
</span><span class="k" data-group-id="8830596086-25">end</span><span class="p" data-group-id="8830596086-24">)</span></code></pre><p>Did you notice the difference? Every step in our interpolation looks similar to items in our dataset! This is the benefit of the VAE: we can generate new items by using random latents. In contrast, in the simple autoencoder, for the most part only latents we got from our encoder were likely to produce sensible outputs.</p>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="fashionmnist_autoencoder.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Training an Autoencoder on Fashion MNIST
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

  </div>
</div>
      <footer class="footer">
        <p>

            <span class="line">
              <a href="https://hex.pm/packages/axon/0.3.0" class="footer-hex-package">Hex Package</a>

              <a href="https://preview.hex.pm/preview/axon/0.3.0">Hex Preview</a>

                (<a href="https://preview.hex.pm/preview/axon/0.3.0/show/notebooks/generative/fashionmnist_vae.livemd">current file</a>)

            </span>

          <span class="line">
            <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
              Search HexDocs
            </button>

              <a href="Axon.epub" title="ePub version">
                Download ePub version
              </a>

          </span>
        </p>

        <p class="built-using">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.29.1) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</section>
</div>

<!-- Render math with KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css" integrity="sha384-t5CR+zwDAROtph0PXGte6ia8heboACF9R5l/DiY+WZ3P2lxNgvJkQk5n7GPvLMYw" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" integrity="sha384-FaFLTlohFghEIZkw6VGwmf9ISTubWAVYW8tG8+w2LAIftJEULZABrF9PPFv+tVkH" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js" integrity="sha384-bHBqxz8fokvgoJ/sc17HODNxa42TlaEhB+w8ZJXTc2nZf1VgEaFZeZvT4Mznfz0v" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
      ]
    });
  });
</script>

<!-- Render diagrams with Mermaid -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@8.13.3/dist/mermaid.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    mermaid.initialize({ startOnLoad: false });
    let id = 0;
    for (const codeEl of document.querySelectorAll("pre code.mermaid")) {
      const preEl = codeEl.parentElement;
      const graphDefinition = codeEl.textContent;
      const graphEl = document.createElement("div");
      const graphId = "mermaid-graph-" + id++;
      mermaid.render(graphId, graphDefinition, function (svgSource, bindListeners) {
        graphEl.innerHTML = svgSource;
        bindListeners && bindListeners(graphEl);
        preEl.insertAdjacentElement("afterend", graphEl);
        preEl.remove();
      });
    }
  });
</script>

  </body>
</html>
